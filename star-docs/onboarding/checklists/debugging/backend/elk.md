# دیباگ با استفاده از استک ELK (Elastic Logstash Kibana)


برای باگ‌هایی که به کندی یک عملکرد در سیستم مربوط است یکی از راه‌های دیباگ و تشخیص مشکل استفاده از لاگ‌های 
performance
که سرویس‌های ستاره ثبت می‌کنند استفاده کنیم.

## تشخیص سرویس‌های مرتبط
با توجه به ماژولی که با آن کار داریم و کندی در آن مشاهده می‌شود لاگ سرویس مربوط را از مشتری درخواست کرده و برای بارگذاری دانلود کنید.

## بارگذاری لاگ‌ها

برای بارگذاری و به اشتراک‌گذاری نتایج بین افراد مختلف داخل واحد یک نسخه‌ی کامل از استک
ELK
در دسترس است.
برای بارگذاری یک فایل لاگ لازم است مراحل زیر را طی بشود.

+ به سرور
  `192.168.30.83`
با نام کاربری و رمزعبوری که در اختیار دارید.
+ در آدرس زیر پوشه‌های مختلف به ازای هر پروژه ایجاد شده است.
پوشه‌ی متناظر با پروژه‌ی باگ گزارش شده را باز کنید. (برای اینکار از فیلد component در ایشوی باگ جیرا استفاده کنید.)

در مثال زیر در پوشه‌ی 
`IST`
مورد نظر است.

![Folders for every project in server](images/folder-projects.png)
![Bug in jira](images/bug-in-jira.png)

+ در پوشه‌ی مورد نظر یک پوشه‌ی جدید به همان نام آیدی ایشوی جیرا ایجاد کنید.
در مثال زیر شناسه‌ی ایشو در جیرا برابر مقدار 
`DATALM-101006`
است.
![Issue code in jira](images/issue-code-details.png)

+ چون فایل‌های لاگ حجیم هستند معمولا به صورت فشرده نگه‌داری و ارسال می‌شوند. برای بارگذاری شدن مناسب لاگ‌ها باید آن‌ها را از حالت فشرده خارج کنید.
+ بررسی کنید که سرویس ویندوزی 
filebeat
در سرور 
در حال اجرا باشد و در صورتی که این سرویس 
stop 
شده باشد فرایند به درستی انجام نمی‌شود و باید آن را 
start
کنید.

![Filebeat service is running](images/filebeat-is-running.png)


## تحلیل لاگ‌ها

برای تحلیل لاگ‌ها روش‌های مختلفی در رابط کاربری کیبانا فراهم شده است.

### تحلیل لاگ با Discover

محیط 
Discover
کیبانا یک محیط برای مشاهده‌ی خام تمام لاگ‌های ثبت شده است. در این صفحه به سادگی می‌توانیم لاگ‌ها فیلتر کنیم. براساس برخی ستون‌ها مرتب‌سازی کنیم و برخی از مقادیر را از محدوده‌ی دید خود حذف کنیم. 

:::tip
این محیط مناسب رسم نمودارهای متنوع و با جزئیات نیست و فقط لاگ‌ها به صورت خام مشاهده می‌شود. برای نمودارهای پیچیده‌تر باید یک داشبورد بسازیم.
:::

این محیط از 
[این آدرس](http://192.168.30.101:5600/app/discover)
قابل دسترس است.

#### تغییر محدوده‌ی زمانی
![Kibana timestamp](images/kibana/timestamp.png)
در این بخش امکان تعیین محدوده‌ی زمانی نمایش لاگ‌ها وجود دارد.

:::tip
در ابتدای تحلیل این مقدار تا حدی که مطمئن باشید شامل تمام لاگ‌های مورد نظر است بزرگ کنید.
:::

#### اضافه کردن ستون‌های داده
![Kibana add columns](images/kibana/columns.png)

در این بخش ستون‌های معروف و پرتکرار در لاگ‌ها به همراه امکان جستجو و اضافه کردن ستون‌ها به جدول وجود دارد.

با انتخاب یک ستون (در بخش ستون‌های معروف یا جستجوی دقیق ستون) ستون خاص به جدول سمت راست اضافه می‌شود و می‌توانیم مقدارها را به صورت دقیق مشاهده کنیم. 
#### مشاهده یا عدم مشاهده‌ی یک داده‌ی خاص در ستون‌های مختلف

با انتخاب هر یک از مقادیر در ستون‌های موجود در جدول اگر روی علامت + کلیک بشود این مقدار 
فیلتر
می‌شود یعنی فقط لاگ‌هایی که این مقدار را دارند نمایش داده می‌شوند.

در صورتی که روی علامت - کلیک بشود تمام لاگ‌هایی که این مقدار را دارند نشان داده نمی‌شوند. این ویژگی برای حذف لاگ‌های نامرتبط و تمرکز روی موارد مهم مفید است. 

#### مشاهده‌ی تجمع زمانی داده‌ها و تعداد کل داده‌های مطابق با فیلتر

در تمام لحظات تحلیل مطابق با فیلتر زمانی و فیلترهای ستون‌ها تعداد کل لاگ‌ها، فراوانی زمانی (صرفا از نظر تعداد) قابل مشاهده است.
همین موارد در برخی از تحلیل‌ها به ما کمک می‌کند و حائذ اهمیت است.

![Time line and total count](images/kibana/timeline.png)
####
####


## تحلیل‌های تجمیعی

## مشخصات و کلیدهای معروف در لاگ‌ها

+ activity
+ area
+ log_type
+ process tag
+ response time
+ distributed transaction id
+ transaction id
+ took
+ log.file.path
+ other fields
+ 